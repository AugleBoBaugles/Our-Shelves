name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]



jobs:
    deploy:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}

        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Deploy to Digital Ocean VM
              uses: appleboy/ssh-action@v1.0.0
              env:
                MYSQL_USER: ${{ secrets.MYSQL_USER }}
                MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD}}
                MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE}}
                DB_PORT: ${{ secrets.DB_PORT }}
                PORT: ${{ secrets.PORT }}
                HOST: ${{ secrets.HOST}}
                VITE_API_URL: http://${{secrets.HOST}}:${{secrets.PORT}}
              with:
                host: ${{ secrets.VM_HOST }}
                username: ${{ secrets.VM_USERNAME }}
                password: ${{ secrets.VM_PASSWORD }}
                timeout: 60s  
                command_timeout: 50m 
                envs: MYSQL_USER,MYSQL_PASSWORD,MYSQL_DATABASE,DB_PORT,PORT,HOST,VITE_API_URL
                script: |
                    set -xe
                    echo "Ensure /home/OurShelves exists"
                    cd /home/OurShelves || { mkdir -p /home/OurShelves && cd /home/OurShelves; }

                    echo "Pull or clone repo"
                    if [ -d "Our-Shelves/.git" ]; then
                      echo "Repo exists, pulling latest"
                      cd Our-Shelves
                      git pull origin main
                    else
                      echo "Repo does not exist, cloning"
                      rm -rf Our-Shelves 
                      git clone https://github.com/AugleBoBaugles/Our-Shelves.git
                      cd Our-Shelves
                    fi

                    dos2unix backend/wait-for-db.sh
                    echo "Write .env file"
                    cat > .env <<EOF
                    MYSQL_USER=$MYSQL_USER
                    MYSQL_PASSWORD=$MYSQL_PASSWORD
                    MYSQL_DATABASE=$MYSQL_DATABASE
                    DB_PORT=$DB_PORT
                    PORT=$PORT
                    HOST=$HOST
                    VITE_API_URL=$VITE_API_URL
                    EOF

                    echo "Ensure docker is closed, then open Docker"
                    docker compose down
                    docker compose up -d --build

                    echo "Wait for frontend"
                    timeout 60 bash -c 'until curl -sf http://localhost:5173; do sleep 2; done'

                    echo "Done!"

            - name: Verify deployment
              uses: appleboy/ssh-action@v1.0.0
              with:
                host: ${{ secrets.VM_HOST }}
                username: ${{ secrets.VM_USERNAME }}
                password: ${{ secrets.VM_PASSWORD }}
                script: |
                    echo "Sanity check which images are running, prune images"
                    cd /home/OurShelves/Our-Shelves
                    docker compose ps
                    docker image prune -f


