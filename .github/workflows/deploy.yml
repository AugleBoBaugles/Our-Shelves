name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]



jobs:
    deploy:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}

        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Deploy to Digital Ocean VM
              uses: appleboy/ssh-action@v1.0.0
              env:
                MYSQL_USER: ${{ secrets.MYSQL_USER }}
                MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD}}
                MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE}}
                DB_PORT: ${{ secrets.DB_PORT }}
                PORT: ${{ secrets.PORT }}
                HOST: ${{ secrets.HOST}}
                VITE_API_URL: http://${{secrets.HOST}}:${{secrets.PORT}}
              with:
                host: ${{ secrets.VM_HOST }}
                username: ${{ secrets.VM_USERNAME }}
                password: ${{ secrets.VM_PASSWORD }}
                envs: MYSQL_USER,MYSQL_PASSWORD,MYSQL_DATABASE,DB_PORT,PORT,HOST,VITE_API_URL
                script: |
                    echo "CONNECTED!"

                    cd /home/OurShelves || mkdir -p /home/OurShelves && cd /home/OurShelves 

                    if [ -d ".git" ]; then
                      git pull origin main
                    else
                      git clone https://github.com/AugleBoBaugles/Our-Shelves.git
                    fi

                    cd /home/OurShelves/Our-Shelves
                    cat > .env <<EOF
                    MYSQL_USER=$MYSQL_USER
                    MYSQL_PASSWORD=$MYSQL_PASSWORD
                    MYSQL_DATABASE=$MYSQL_DATABASE
                    DB_PORT=$DB_PORT
                    PORT=$PORT
                    HOST=$HOST
                    VITE_API_URL=$VITE_API_URL
                    EOF

                    docker compose down
                    docker compose up -d --build

                    timeout 60 bash -c 'until curl -sf http://localhost:5173; do sleep 2; done'

                    docker compose ps
                    docker image prune -f

